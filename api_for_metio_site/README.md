
Сервис для получения почасовой погоды по указанному городу.  
Основан на [FastAPI](https://fastapi.tiangolo.com/) и использует [aiosqlite](https://github.com/omnilib/aiosqlite) для работы с базой данных.

## Функциональность

- Получение погоды по названию города (температура, влажность, ветер, погодный код).  
- Сохранение истории запросов для каждого пользователя в таблице users (по двум полям: id пользователя и последний введённый город).  
- Подсчёт количества обращений к каждому городу в таблице sity.  

### Эндпоинты

1. GET /
   - Возвращает приветственное сообщение и короткую инструкцию по использованию.
   - Пример ответа:
     ```json
     {
       "message": "Weather API: используйте POST /weather/{user_id} с {'city': 'Город'}"
     }
     ```

2. POST /weather/{user_id}
   - Принимает на вход JSON с ключом "city":  
     ```json
     {
       "city": "Москва"
     }
     ```
   - Параметр {user_id} — произвольная строка, идентифицирующая пользователя.
   - По результатам запроса:
     - Добавляет или обновляет запись в истории пользователя (таблица users).
     - Увеличивает счётчик обращений к городу (таблица sity).
     - Возвращает текущие и почасовые данные о погоде.
   - Пример вызова (PowerShell):
     ```powershell
     Invoke-RestMethod -Uri "http://127.0.0.1:8000/weather/user123" `
                       -Method Post `
                       -ContentType "application/json" `
                       -Body '{"city": "Москва"}'
     ```

## Структура проекта

- **main.py**  
  Точка входа в приложение FastAPI. Описывает основные маршруты и настройки CORS.
  
- **api/services/wather.py**  
  Модуль, отвечающий за получение погоды и координат выбранного города.  
  Обращается к [Open-Meteo](https://open-meteo.com/) через библиотеку [openmeteo_requests](https://pypi.org/project/openmeteo-requests/),  
  а для геокодирования использует [Nominatim API](https://nominatim.org/) через [aiohttp](https://docs.aiohttp.org/).

- **api/base/database_func.py**  
  Модуль для работы с базой данных:
  - Создание/инициализация таблиц (users, sity).
  - Запись/чтение истории пользователя.
  - Учёт количества обращений к каждому городу.

- **database.py** 
  Тот же функционал, что и вышеописанный файл, от которого зависит `api/base/database_func.py`.

## Запуск и установка
Ниже приведена инструкция по запуску с помощью Docker Compose:

1. Убедитесь, что у вас установлен Docker и Docker Compose (docker-compose).  
2. Клонируйте репозиторий или скачайте проект любым удобным способом.  
3. Перейдите в папку проекта, в которой находится docker-compose.yml.  
4. В терминале выполните команду сборки контейнеров и их запуска:  
   docker-compose up --build  
   После первого запуска последующие разы можно запускать без флага --build, если не менялись образы.  
5. По умолчанию приложение будет доступно на порту 8000 вашего хоста:  
   http://127.0.0.1:8000  

Если хотите изменить порт/настройки, отредактируйте docker-compose.yml по своим требованиям, а затем снова выполните docker-compose up --build.  
При необходимости остановки нажмите Ctrl+C или выполните docker-compose down в другом терминале.

## Используемые технологии

- [FastAPI](https://fastapi.tiangolo.com/) — фреймворк для создания веб-приложений на Python.  
- [SQLite](https://www.sqlite.org/index.html) и [aiosqlite](https://github.com/omnilib/aiosqlite) — для сохранения данных в простую реляционную базу.  
- [aiohttp](https://docs.aiohttp.org/) — для асинхронного выполнения HTTP-запросов.  
- [openmeteo_requests](https://pypi.org/project/openmeteo-requests/) — вспомогательный клиент для работы с Open-Meteo API.  
- [requests_cache](https://pypi.org/project/requests-cache/) — кэширование HTTP-запросов, чтобы не перегружать внешние сервисы.  
- [retry_requests](https://pypi.org/project/retry-requests/) — перезапуск запросов при временных ошибках сети.  
- [pandas](https://pandas.pydata.org/) — преобразование и обработка временных данных (почасовой погоды).

## Дополнительные возможности (План или TODO)

Ниже перечислены пункты, которые могут быть доработаны или уже частично реализованы:

- [x] Создать Dockerfile для контейнеризации проекта  
- [ ] Реализовать автодополнение (подсказки) при вводе города  
- [ ] Упрощённое предложение пользователю посмотреть ранее запрошенные города  
- [x] Сохранение истории пользователя (реализовано в таблице users)  
- [x] Учёт количества запросов к каждому городу (реализовано в таблице sity)  

## Как это работает (Краткая схема)

1. Пользователь отправляет POST-запрос на /weather/{user_id}, где {user_id} — уникальный идентификатор пользователя.
2. Происходит поиск координат города (через Nominatim/OpenStreetMap).
3. Затем с помощью Open-Meteo API запрашиваются погодные данные по найденным координатам.
4. База данных (SQLite) обновляет историю с учётом нового запроса:
   - В таблице users обновляется или создаётся запись для данного user_id.
   - В таблице sity увеличивается счётчик обращений к данному городу.
5. Приложение возвращает в ответ текущую и почасовую погоду в формате JSON.

## Пример запроса/ответа

Запрос (PowerShell):
```powershell
Invoke-RestMethod -Uri "http://127.0.0.1:8000/weather/user123" `
                  -Method Post `
                  -ContentType "application/json" `
                  -Body '{"city": "Москва"}'
```

Пример ответа (усечённый):
```json
{
  "city": "Москва",
  "current": {
    "temperature": 21.5,
    "humidity": 50,
    "wind_speed": 3.2,
    "weather_code": 1
  },
  "hourly": {
    "temperature_2m": [...],
    "relative_humidity_2m": [...],
    "weather_code": [...],
    "wind_speed_10m": [...]
  }
}
```

## Развертывание в Docker (планируется)

(Пока Dockerfile не добавлен. Для развёртывания в контейнере нужно будет:  
1) Создать Dockerfile.  
2) Собрать образ при помощи docker build.  
3) Запустить контейнер.)

---

Рабочая версия приложения готова к запуску и проверке. При повторном посещении (при условии, что пользователь запрашивает тот же user_id) можно узнать, какие города он уже вводил, прочитав из таблицы users, а количество обращений к городам доступно в таблице sity.  
